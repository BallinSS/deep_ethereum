---
title: "详解以太坊合约数据存储布局"
menuTitle: "存储布局"
date: 2019-11-03T15:51:02+08:00
weight: 100000
description: "详解以太坊合约数据存储布局"
---

以太坊所设计的合约数据存储模型，并非常见方式。
因此，即使你身为程序员在理解存储模型时也会觉得新奇。

以太坊合约是经过 EVM 执行后，将从 KV 数据库中读写。这和常见的编程语言的内存数据模型差异很大。这是因为合约在执行后必须方便存储到KV 数据库，也需要能拥有引用指针访问数据能力。

在主流编程语言中，数据的访问都可以通过指针访问，在以太坊中，访问数据是需要从 KV 数据中实时读取，因此在访问前必须知道某个数据确切的存储位置。

合约数据存储采用的是为合约每项数据指定一个可计算的存储位置，数据存在容量为2<sup>256</sup>超级数组中，数组中每项数据的初始值为 0。
你不用担心存储占用太多存储空间，实际上存储时稀疏的。在存储到 KV 数据库中时只有非零(空值)数据才会被写入。

![以太坊数据存储](https://learnblockchain.cn/static/2019-11-3-21-30-13.png?width=600px&heigth=400px)

每个插槽可存储 32 字节数据：

![](https://learnblockchain.cn/static/2019-11-3-21-44-32.png?width=600px)

当某项数据超过 32 字节，则需要占用多个连续插槽(data.length/32)。因此，当数据长度是已知时，则存储位置也是可计算的。


```solidty
pragma solidity >0.5.0;

contract StorageExample {
    uint8  public a = 11;
    uint256 b=12;
    uint[2] c= [13,14];

    struct Entry {
        uint id;
        uint  value;
    }
    Entry d;
}
```

上面合约中，有定义 a、b、c、d 四个存储字段。a、b 分配在 0，1位置。
而字段 c 是定长 2 且元素类型是 uint，需要用 32 字节存储一个元素，一共需要占用两个插槽 2和 3。
字段 d 是一个结构类型数据，其中 Entry 的数据长度也是确定的 64 字节，因此字段 d 也占用两个插槽 4 和 5。

![](https://learnblockchain.cn/static/2019-11-3-22-19-1.png?width=400px)

当数据类型是值类型（固定大小的值）时，编译时将严格根据字段排序顺序，给每个要存储的值类型数据预分配存储位置。
相当于已提前指定了固定不变的数据指针。

部署上面合约，根据合约地址可以直接通过`getStorageAt`API 获取存储数据。

```js
var contractAddr="0xe700184a875390d7c98371769315E9A2504Ad556";
for(i=0;i<6;i++){
    console.log(web3.eth.getStorageAt(contractAddr,i))
}
```

```html
0x000000000000000000000000000000000000000000000000000000000000000b
0x000000000000000000000000000000000000000000000000000000000000000c
0x000000000000000000000000000000000000000000000000000000000000000d
0x000000000000000000000000000000000000000000000000000000000000000e
0x0000000000000000000000000000000000000000000000000000000000000000
0x0000000000000000000000000000000000000000000000000000000000000000
```

上面是根据存储位置所有遍历合约存储， 存储到 DB 的数据是十六进制，我们可以直接使用工具类转换数据。
```
web3.toBigNumber(web3.eth.getStorageAt(contractAddr,0))
// 输出： 11
```

{{% notice warning %}}
注意，本文脚本时运行在 geth 控制台中，和 NodeJs 运行有所差异。geth 控制台中有修改 web3 方法定义。
{{% /notice %}}


但如果数据长度是不确定的呢？如数组、Map等，或者说数据仅需要占用 1 字节呢？如 bool值。
在存储模型中有包含一点规则来涉及存储布局。

## 存储规则

###
1. 如果可能的话，存储需求少于 32 字节的多个变量会被打包到一个 存储插槽storage slot 中




